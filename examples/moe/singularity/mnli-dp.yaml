description: moe-mnli-dp

target:
    service: sing
    name: msrresrchvc

# environment:
#   image: amlt-sing/pytorch-1.12.1-rocm5.2.3
#   image_setup:
#     - pip install torch==1.12.1
#     - pip install transformers==4.26.0
#     - pip install datasets==2.6.2
#     - pip install evaluate
#     - pip install sentencepiece
#     - pip install scikit-learn
#   setup:
#     - pip install .

environment:
  image: amlt-sing/pytorch-1.8.0-cuda11.1-cudnn8-devel
  image_setup:
    - pip install numpy==1.24.1
    - pip install torch==1.12.1
    - pip install transformers==4.26.0
    - pip install datasets==2.6.2
    - pip install evaluate
    - pip install sentencepiece
    - pip install scikit-learn
  setup:
    - pip install .

code:
  local_dir: $CONFIG_DIR/../../../

storage:
  input_path:
    # You should use your own blob here
    storage_account_name: huinan
    container_name: amulet
  output_path:
    # You should use your own blob here
    storage_account_name: huinan
    container_name: amulet


search:
  job_template:
    name: moe-full-dp-mnli_{experiment_name:s}_{auto:4s}
    sku: 16G8-V100
    command:
      - python -m torch.distributed.run --nproc_per_node 8 examples/moe/fine-tune-dp-cls.py
        --data_dir /mnt/input_path/huggingface
        --task {task}
        --output_dir /mnt/input_path/huggingface/moe/mnli/dp/{experiment_name:s}_{auto:4s}
        --save_strategy no
        --model_name google/switch-base-8
        --sequence_len {sequence_len}
        --per_device_train_batch_size 3
        --gradient_accumulation_steps 64
        --evaluation_strategy epoch
        --log_level info
        --per_device_eval_batch_size 4
        --eval_accumulation_steps 1
        --seed 42
        --weight_decay 0.01
        --remove_unused_columns False
        --num_train_epochs {num_train_epochs}
        --logging_steps 20
        --max_grad_norm 0
        --lr_scheduler_type constant
        --learning_rate {learning_rate}
        --per_sample_max_grad_norm 1.0
        --target_epsilon {target_epsilon}
        --label_names "labels"
        --disable_tqdm True
        --dataloader_num_workers 2
        --report_to azure_ml
        $EXTRA_ARGS
    sla_tier: premium  # Default: premium
    execution_mode: basic  # Default: basic
    priority: medium  # Default: medium
  type: grid
  max_trials: 1
  params:
    - name: num_train_epochs
      values: choice(10)
    - name: learning_rate
      values: choice(0.0005)
    - name: sequence_len
      values: choice(128)
    - name: task
      values: choice("SetFit/mnli")
    - name: target_epsilon
      values: choice(8.0)
